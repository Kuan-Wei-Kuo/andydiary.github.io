{"componentChunkName":"component---src-templates-blog-post-js","path":"/淺談樂觀鎖與實戰/","result":{"data":{"site":{"siteMetadata":{"title":"Andy Diary"}},"markdownRemark":{"id":"728897bf-e402-50cc-bbdd-2bd38a64b6f7","excerpt":"…","html":"<p>在上一篇我們談過了悲觀鎖的實際應用，與悲觀鎖不同的是，樂觀鎖並沒有對資料進行上鎖動作，我們允許同時進行對該筆的修改，也因此有可能造成資料不符合預期結果的問題產生。</p>\n<p>試想一下，我們並沒有對資料強行上鎖，也就是說我們其實是可以針對該筆資料同時運行多個動作，到底哪個請求是才算我們預期的結果，在併發情況下我們並無法準確得知。</p>\n<h2>樂觀鎖</h2>\n<p><strong>樂觀鎖(Optimistic Locking)</strong>，相較於悲觀鎖，我們會認為資料更新並不頻繁，也因此允許同時對該筆資料進行多個動作，也代表我們其實並未針對該筆資料上鎖。在樂觀鎖上，我們會在 table 欄位上添加 version 欄位來進行更新的確認，在更新資料前我們會撈取該筆資料的 version 並且在更新時，利用這個 version 與 table 內目前的 version 進行比對，若相同則代表這段時間沒有人修改資料，可進行更新動作；反之代表有人比你早一步更新。</p>\n<h2>實戰</h2>\n<p>我們一樣使用悲觀鎖實戰中的資料表進行演練，表格內容如下。</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Column</th>\n<th align=\"center\">Type</th>\n<th align=\"center\">Primary Key</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">product_id</td>\n<td align=\"center\">INT</td>\n<td align=\"center\">YES</td>\n</tr>\n<tr>\n<td align=\"center\">amount</td>\n<td align=\"center\">INT</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">version</td>\n<td align=\"center\">INT</td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n<h3>Spring Data JPA</h3>\n<p>在 Spring Data JPA 中我們可以在 Entity 中加入 <strong>@Version</strong> 來幫助我們進行樂觀鎖的實現。</p>\n<h4>Entity</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\r\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"stock\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Stock</span> <span class=\"token punctuation\">{</span>\r\n\r\n\t<span class=\"token annotation punctuation\">@Id</span>\r\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"product_id\"</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> productId<span class=\"token punctuation\">;</span>\r\n\r\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"amount\"</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> amount<span class=\"token punctuation\">;</span>\r\n\t\r\n\t<span class=\"token annotation punctuation\">@Version</span>\r\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"version\"</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> version<span class=\"token punctuation\">;</span>\r\n\r\n\t<span class=\"token comment\">// getters and setters</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Repository</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Repository</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">StockRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Stock</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\r\n\r\n\t<span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT s FROM Stock s WHERE s.productId = :productId\"</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Stock</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByProductId</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Service</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StockServiceImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">StockService</span> <span class=\"token punctuation\">{</span>\r\n\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">StockRepository</span> stockRepository<span class=\"token punctuation\">;</span>\r\n\t\r\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">StockServiceImpl</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StockRepository</span> stockRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stockRepository <span class=\"token operator\">=</span> stockRepository<span class=\"token punctuation\">;</span>\r\n\t<span class=\"token punctuation\">}</span>\r\n\t\r\n\t<span class=\"token annotation punctuation\">@Transactional</span>\r\n\t<span class=\"token annotation punctuation\">@Override</span>\r\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">StockDto</span> <span class=\"token function\">checkStock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> productId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> amount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Stock</span><span class=\"token punctuation\">></span></span> optional <span class=\"token operator\">=</span> stockRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByProductId</span><span class=\"token punctuation\">(</span>productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t\r\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>optional<span class=\"token punctuation\">.</span><span class=\"token function\">isPresent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"product id not found, id: \"</span> <span class=\"token operator\">+</span> productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token punctuation\">}</span>\r\n\t\t\r\n\t\t<span class=\"token class-name\">Stock</span> stock <span class=\"token operator\">=</span> optional<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        \r\n\t\t<span class=\"token keyword\">int</span> existAmount <span class=\"token operator\">=</span> stock<span class=\"token punctuation\">.</span><span class=\"token function\">getAmount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\tstock<span class=\"token punctuation\">.</span><span class=\"token function\">setAmount</span><span class=\"token punctuation\">(</span>existAmount <span class=\"token operator\">-</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n\t\tstockRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">convertToDto</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t<span class=\"token punctuation\">}</span>\r\n\t\r\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">StockDto</span> <span class=\"token function\">convertToDto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stock</span> stock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t<span class=\"token class-name\">StockDto</span> stockDto <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StockDto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\tstockDto<span class=\"token punctuation\">.</span><span class=\"token function\">setProductId</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">.</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\tstockDto<span class=\"token punctuation\">.</span><span class=\"token function\">setAmount</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">.</span><span class=\"token function\">getAmount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token keyword\">return</span> stockDto<span class=\"token punctuation\">;</span>\r\n\t<span class=\"token punctuation\">}</span>\r\n\t\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>模擬測試</h2>\n<ol>\n<li>庫存數量為 100</li>\n<li>QPS 平均為 100/sec</li>\n</ol>\n<h3>Test case</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0a31f4d4cf4dee3b43f65c88033a606e/eac55/wqN7YMA.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.10126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVR42pWSyXKEMAxE+Zncc8hM2Ay2kRcMBrNUTc0pyf9/RKdwJlTmFDj0RSp1vZaUSNKQyqDRmyzIWJC2sSbVT0+7DmRbqNahrMUuxiUYF0+1RLoWgkxsNspguX+gCws6P4BMi6LiTwP/Kbl1DlYqpKwGbxSGeUWYV/RjgO18rG2mR5V8lSV8UaKoBSQp+HFCP4TYzFl9ii4S9kwie+d4uVS4VoQxzPBhgrIuruE38mHC+1sKuuR4LTiYIAzzAj8t0bASzXnCz2uKPsuRPyIHbTGRgpWEStJOd9hw6R2MVMhYjSpeWkNtL0N6j3HGNFlbAyMI+WPA+RFjvPIUf/L020y3BcZ0kXA7wra3TewP1ZnI3/pMYIt9xpm0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"wqN7YMA\"\n        title=\"wqN7YMA\"\n        src=\"/static/0a31f4d4cf4dee3b43f65c88033a606e/f058b/wqN7YMA.png\"\n        srcset=\"/static/0a31f4d4cf4dee3b43f65c88033a606e/c26ae/wqN7YMA.png 158w,\n/static/0a31f4d4cf4dee3b43f65c88033a606e/6bdcf/wqN7YMA.png 315w,\n/static/0a31f4d4cf4dee3b43f65c88033a606e/f058b/wqN7YMA.png 630w,\n/static/0a31f4d4cf4dee3b43f65c88033a606e/eac55/wqN7YMA.png 887w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>可以看到我們請求並不是很正常，讓我們接下去看看發生何種錯誤。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">org.hibernate.StaleStateException: \r\nBatch update returned unexpected row count from update [0]; \r\nactual row count: 0; expected: 1; \r\nstatement executed: update stock set amount=?, version=? where product_id=? and version=?</code></pre></div>\n<p>在錯誤訊息中，我們不難發現，更新失敗原因為 version 對應失敗，這也應證了我們一開始所說的樂觀鎖機制。</p>\n<p>接下來讓我們看看資料表結果如何。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 263px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8198e067a7e75959b6bb414debc78f85/17741/iIdGAfG.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.11392405063291%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJklEQVR42l2QXW6DMBCEuf95+twDNGkrNQ/kFxxjwII0TUCBGNv5KltNFHWklXZXmtHMJIUsOBxa2rahqirqqqbvO7LtlrfZjCzLaZqGz4939lIRcLvduCPsz3eySlOk0qhSI2VBVWvGcaRUivl8Tp4LqrJksfiiqvSDaK3FOc8zrHUkUbt+xYoXlD6xWa8pCoUq60gKlF070J3PZJlgu91RqIJpsozDgMgFyzSNRoyZSPqLYTws6dSMXV6wTJcIIVivNnRdFwXlceR4/I4JpFQ07U905J1Da40Ue2p9IiRPuu6MmTzXyeOcxfvg2VGWBiFO/IcxsFlHOe7VeQdKgfOe5DIMXK9j7C3M8Hf3fdivsXDvfRznXOzJGP/4ee+wU/iHLDd+AedpyXYuotraAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"iIdGAfG\"\n        title=\"iIdGAfG\"\n        src=\"/static/8198e067a7e75959b6bb414debc78f85/17741/iIdGAfG.png\"\n        srcset=\"/static/8198e067a7e75959b6bb414debc78f85/c26ae/iIdGAfG.png 158w,\n/static/8198e067a7e75959b6bb414debc78f85/17741/iIdGAfG.png 263w\"\n        sizes=\"(max-width: 263px) 100vw, 263px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>可以看到我們在 QPS 平均為 100/sec 的情況下，實際上只有扣除 37 份庫存，這也是樂觀鎖最直接的體現，在併發的時候結果不符合預期。</p>\n<h2>結論</h2>\n<p>從上述測試過程中，會覺得樂觀鎖資料不符合預期的狀況非常嚴重，但這種鎖定機制並非沒有用處，例如也許我們可以在更新用戶資料時使用該鎖，還是可以確保一定的資料正確性。</p>\n<p>悲觀鎖與樂觀鎖的實際應用，並沒有強制的規定，我們應該要理解為何使用這種鎖，我們想要解決怎樣的問題。</p>","frontmatter":{"title":"淺談樂觀鎖與實戰","date":"2023-01-28","description":null}},"previous":{"fields":{"slug":"/淺談悲觀鎖與實戰/"},"frontmatter":{"title":"淺談悲觀鎖與實戰"}},"next":null},"pageContext":{"id":"728897bf-e402-50cc-bbdd-2bd38a64b6f7","previousPostId":"db4bed9f-17c5-5af6-bdd7-66d18cd1f7e6","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}