{"componentChunkName":"component---src-templates-blog-post-js","path":"/java-concurrency/04/","result":{"data":{"site":{"siteMetadata":{"title":"Andy Diary"}},"markdownRemark":{"id":"1e851418-652a-5a3a-9651-fbd1d4fdd9f8","excerpt":"如何造成死鎖 基本上要造成死鎖的條件有四個，如下說明 禁止搶占: 已經分配的資源不能被強制性釋放。 持有與等待: 執行緒已經持有了至少一個資源，並且正在等待獲取其他資源。 互斥: 至少有一個資源被設置成了互斥狀態，即一次只能由一個執行緒訪問。 循環等待: 存在一個等待循環，即執行緒A正在等待執行緒B持有的資源，執行緒B…","html":"<h2>如何造成死鎖</h2>\n<p>基本上要造成死鎖的條件有四個，如下說明</p>\n<ul>\n<li>禁止搶占: 已經分配的資源不能被強制性釋放。</li>\n<li>持有與等待: 執行緒已經持有了至少一個資源，並且正在等待獲取其他資源。</li>\n<li>互斥: 至少有一個資源被設置成了互斥狀態，即一次只能由一個執行緒訪問。</li>\n<li>循環等待: 存在一個等待循環，即執行緒A正在等待執行緒B持有的資源，執行緒B正在等待執行緒C持有的資源，而執行緒C正在等待執行緒A持有的資源。</li>\n</ul>\n<p>讓我們用一張圖來看看</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 233px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/78c82460d7ec94a3759769809baf9446/a1d58/dead_lock.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 134.17721518987344%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAYAAAB836/YAAAACXBIWXMAAAsTAAALEwEAmpwYAAADK0lEQVR42qVVW5OaWBCe//9LsslTsnnYJG7V1mwyI4jMKKho4mUUuYMoqCCXb6uPgjjizkNO1VenPd183X26+3gHAHme43dXwXFXCGmWYOKMMLZHGJf7T8zXU8z9Kdtn3pidVW2mzi8c0rgkLQnpsLMU0dU6JZ7VJ3xp/YW/nxpoiN/wffAvO+vqZxtJe0Z02NUTSloHPaOHniGjb/Yg6zIa7QY+//iMT/ef8Kg8QNK6TEc2R0j1hEl6QF/vom9I6Bsyuuoz+rqEkavgpzfEL28Ixe6Xup4uQSZynQj314S0x0nEvB2yGKq2wC4KESd7dnbEntm4KxtpntBXt4vyelmWhSzNanV0bhgmlIECRRnCMIxzhIWw2+2wXvtYrVYIw5ARJklSGpZ3fTig3W7DdV1MJhOMx2MsFotrwvl8DlmWmTHJvu8jTdOrlGhpmvZ2H14osxyyJCMIgqsIN5sNi77QZVmGah3uqh8QyEDXdShDBaqqXkRJ6ZKuiLJ6JReE1UPy7LoeHu856JrB7rNYnuchCMJSLnTVLK8I1xsfy5mBibiENrPgem5p7NgOojhichzHsG37bUIqhuesYC9WCDc7WLZ1jnDlwdZdqEMTvruB4zpvE1Iq2+329GCkME3zglB/sTDr6rA1F94p+v8lpD6kSh4rGrDfxSKZMuC5Vu0d1halWkmKjhq+WmWq7svLDMvlkv0uOqN2lgsFTYHjOAx1fdjpdC4cXTT2rRebxqrqubpT5ORsOp1CURQ2WVcR0jx2u13IksSGncaQWuN14yPPGSFlQY1PoMm5IqQLX6gq82ZaFtIsQ3bjJTJN6/Ys16ac5/BdF0kUIY1jJCeQnFHRVLXUEfK6oqRxBL/5iIBvIuA5rLlHtu/bAuKnNsO+3ULY4uA3H9ge8hw2Ao9kv6snJINYFBCJR5KtwEP88B7ihz8gvH+HwZ8fmcPDs3i0EQVs2wKS0yBcEkYRguYDIoHHXuCwb3FMdu7/gdr4isW3L0ze8c2TDc/2bYurJ8ySBGG/hy1hcEY0HCAeDXEYDZm8HfTP+n4PoTJg93j1HuL0l/MaWQX5DVSr/B8lPhJ+GWmDEgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dead_lock\"\n        title=\"\"\n        src=\"/static/78c82460d7ec94a3759769809baf9446/a1d58/dead_lock.png\"\n        srcset=\"/static/78c82460d7ec94a3759769809baf9446/c26ae/dead_lock.png 158w,\n/static/78c82460d7ec94a3759769809baf9446/a1d58/dead_lock.png 233w\"\n        sizes=\"(max-width: 233px) 100vw, 233px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>圖中其實我們最簡單的可以看到循環等待的事情發生，接下來除了這條件外，我們利用物件鎖來嘗試完成這次的死鎖。</p>\n<h3>造成死鎖看看</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Example01</span> <span class=\"token punctuation\">{</span>\r\n    \r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> objLock1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> objLock2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>objLock1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"Locked 1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>objLock2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"Locked 2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token punctuation\">}</span>\r\n            <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token class-name\">Thread</span> t2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>objLock2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"Locked 2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>objLock1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"Locked 1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token punctuation\">}</span>\r\n            <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        t2<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        t2<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>當大家執行上述程式碼時，我們完成了造成死鎖的四個條件，也確實成功產生死鎖，並且只能強制程式退出運行。</p>\n<h3>解除死鎖</h3>\n<p>如果說造成死鎖的原因，是得滿足上述的四個條件，那假設我們來破壞這四個條件其中之一看看呢? 大概想法為以下:</p>\n<ul>\n<li>避免循環等待</li>\n<li>避免巢狀鎖</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Example02</span> <span class=\"token punctuation\">{</span>\r\n    \r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> objLock1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> objLock2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>objLock1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"Locked 1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token punctuation\">}</span>\r\n            <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>objLock2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"Locked 2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token class-name\">Thread</span> t2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>objLock2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"Locked 2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>objLock1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"Locked 1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token punctuation\">}</span>\r\n            <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        t2<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        t2<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在上面我們將第一個 Thraed 的鎖改成非巢狀鎖並且解除循環等待，但我們第二個 Thread 保持在舊有方式，在這邊我們可以看到程式碼會正常運行，並且沒有死鎖問題，這是因為我們兩個 Thread 的競爭狀況已經被我們破壞。</p>\n<h2>結論</h2>\n<p>這次我們成功使用四個條件造成死鎖，鎖在併發情形下是非常重要的，做得好帶來效能，反之，若今天我們對鎖並沒有好好的編排與設計，帶來的絕對是災難。</p>\n<h2>參考</h2>\n<p><a href=\"https://chat.openai.com/chat\">https://chat.openai.com/chat</a><br>\r\n<a href=\"https://medium.com/bucketing/java-concurrency-3-%E6%AD%BB%E9%8E%96-deadlock-ec82e01822f6\">https://medium.com/bucketing/java-concurrency-3-%E6%AD%BB%E9%8E%96-deadlock-ec82e01822f6</a><br>\r\n<a href=\"https://www.developer.com/java/java-prevent-thread-deadlock\">https://www.developer.com/java/java-prevent-thread-deadlock</a></p>","frontmatter":{"title":"Java Concurrency #04 - 如何造成死鎖以及解決方法","date":"2023-04-16","description":null}},"previous":{"fields":{"slug":"/java-concurrency/03/"},"frontmatter":{"title":"Java Concurrency #03 - 關於 synchronized lock 的那點事"}},"next":{"fields":{"slug":"/java-concurrency/05/"},"frontmatter":{"title":"Java Concurrency #05 - Thread 的生命週期"}}},"pageContext":{"id":"1e851418-652a-5a3a-9651-fbd1d4fdd9f8","previousPostId":"7c05b49c-c859-5fd4-adf5-a04b7f10d50e","nextPostId":"7fe40828-3311-5ba1-8630-e7eb3654045f"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}