{"componentChunkName":"component---src-templates-blog-post-js","path":"/CSRF Token 在 Stateless 中所造成的競爭條件/","result":{"data":{"site":{"siteMetadata":{"title":"Andy Diary"}},"markdownRemark":{"id":"e6301c50-d77a-59db-bda5-dffd3f3b5365","excerpt":"往往我們在 Spring Security 中要進行無狀態的服務撰寫時，將會設置 SessionCreationPolicy.STATELESS 使 Spring Security 不會產生 Session，然而在 Spring CSRF 防範的機制中，這樣的設定將會造成每個請求都會 Rotated CSRF…","html":"<p>往往我們在 Spring Security 中要進行無狀態的服務撰寫時，將會設置 SessionCreationPolicy.STATELESS 使 Spring Security 不會產生 Session，然而在 Spring CSRF 防範的機制中，這樣的設定將會造成每個請求都會 Rotated CSRF Token。</p>\n<h2>問題</h2>\n<p>在應用當中，我們將會把 Csrf Token 放入 Cookie 並且在請求資源時，將 XSRF-Token 放入 Header 中，以達到 Double Submit 的目的。可是我們將會遇到一個問題，在大量請求下，可能在發後請求途中，被先前返回的請求更改 Csrf Token，當我們該次的請求將會出現 Csrf mismatch 的問題。</p>\n<h2>解決方案</h2>\n<p>這邊的解決方案，筆者查閱相關資訊，決定使用每一次登入只產生一次 Csrf Token 的思路來解決，這種思路我認為，若保持 SameSite 且 Origin 進行相關規範，以及強化 Csrf Token 的隨機性，應該還是有一定保護效果。</p>\n<p>如果各位翻閱 CsrfFilter 以及 CsrfTokenRepository 可能會無法發現，每一次 Request 都進行 Rotated CSRF Token 的位置，其實這就要回到 Spring Security Filter Chain 的順序當中，當我們登入成功後，將會到 SessionManagementFilter 上，該 Filter 將會呼叫 SessionAuthebtiucationStrategy，而 CsrfAuthenticationStrategy 將會進行兩個動作，即為移除 Csrf Token 以及 刷新 Csrf Token。</p>\n<p>所以我們將自定義 CsrfAuthenticationStrategy 來讓我們達到每一次登入僅產生一次 Csrf Token。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 553px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b267d812b6a6431aaa08b9079833502c/74cfa/spring_csrf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.810126582278485%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8klEQVR42o2L4UrDQBAG8/7vZJLSVBDBNo1gQQTb3jVNTK5tckl3b2/3JCCCUtDh+7GzMJHFvrwcVLPTRjW2duSYBaHnYeed9SzOYd0dldmrdq/NNNXutNkP2EdVXz6+PyR5vNhkL9VzbztE6k6KTIa2BKSuO+fbp7SIZ0WSrO5m6yRdx4vNvLLHiJiubkQP4AEIJEgI4WTaUr21TRUmBAiudEWPFuw4HZOSpyjcgpk9CzP/+hORiHzr7fgHEpAESJwPp4sdgNBP6ln+jkXC6rWZ5/q+OMyW2yzXWa7SpdLt+K/44wy6GUozlu3XVG37kT4BTXaO+hLKaUwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Spring CSRF Token\"\n        title=\"Spring CSRF Token\"\n        src=\"/static/b267d812b6a6431aaa08b9079833502c/74cfa/spring_csrf.png\"\n        srcset=\"/static/b267d812b6a6431aaa08b9079833502c/c26ae/spring_csrf.png 158w,\n/static/b267d812b6a6431aaa08b9079833502c/6bdcf/spring_csrf.png 315w,\n/static/b267d812b6a6431aaa08b9079833502c/74cfa/spring_csrf.png 553w\"\n        sizes=\"(max-width: 553px) 100vw, 553px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>CustomCsrfAuthenticationStrategy</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomCsrfAuehtenticationStrategy</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">SessionAuthenticationStrategy</span> <span class=\"token punctuation\">{</span>\r\n\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> log logger <span class=\"token operator\">=</span> <span class=\"token class-name\">LogFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLog</span><span class=\"token punctuation\">(</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    \r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CsrfTokenRepository</span> csrfTokenRepository<span class=\"token punctuation\">;</span>\r\n    \r\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CustomCsrfAuehtenticationStrategy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CsrfTokenRepository</span> csrfTokenRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    \t<span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">notNull</span><span class=\"token punctuation\">(</span>csrfTokenRepository<span class=\"token punctuation\">,</span> <span class=\"token string\">\"csrfTokenRepository cannot be null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    \t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>csrfTokenRepository <span class=\"token operator\">=</span> csrfTokenRepository<span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    \r\n    <span class=\"token annotation punctuation\">@Override</span>\r\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Authentication</span> authentication<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletReponse</span> reponse<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SessionAuthenticationException</span> <span class=\"token punctuation\">{</span>\r\n    \t<span class=\"token keyword\">boolean</span> containsToken <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>csrfTokenRepository<span class=\"token punctuation\">.</span><span class=\"token function\">loadToken</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>containsToken <span class=\"token operator\">&amp;&amp;</span> authentication<span class=\"token punctuation\">.</span><span class=\"token function\">isAuthenticated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        \tcsrfTokenRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token class-name\">CsrfToken</span> newToken <span class=\"token operator\">=</span> csrfTokenRepository<span class=\"token punctuation\">.</span><span class=\"token function\">generateToken</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            csrfTokenRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveToken</span><span class=\"token punctuation\">(</span>newToken<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            request<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CsrfToken</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> newToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            request<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span>newToken<span class=\"token punctuation\">.</span><span class=\"token function\">getParameterName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> newToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            logger<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Replaced CSRF Token\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    \r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>SecurityConfig</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Override</span>\r\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpSecurity</span> http<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\r\n\thttp\r\n    \t<span class=\"token punctuation\">.</span><span class=\"token function\">csrf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        \t<span class=\"token punctuation\">.</span><span class=\"token function\">sessionAuthenticationStrategy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomCsrfAuthenticationStrategy</span><span class=\"token punctuation\">(</span><span class=\"token function\">getCsrfTokenRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    \t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">CsrfTokenRepository</span> <span class=\"token function\">getCsrfTokenRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t<span class=\"token class-name\">CookieCsrfTokenRepository</span> tokenRepository <span class=\"token operator\">=</span> <span class=\"token class-name\">CookieCsrfTokenRepository</span><span class=\"token punctuation\">.</span><span class=\"token function\">withHttpOnlyFalse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    tokenRepository<span class=\"token punctuation\">.</span><span class=\"token function\">setCookiePath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> tokenRepository<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>結論</h2>\n<p>筆者並不是所謂的資安專家，因此也無法證實這個解決方案是可行並且安全，全當一次紀錄。</p>\n<h2>參考</h2>\n<p><a href=\"https://docs.spring.io/spring-security/site/docs/4.2.1.RELEASE/reference/htmlsingle/#filter-ordering\">https://docs.spring.io/spring-security/site/docs/4.2.1.RELEASE/reference/htmlsingle/#filter-ordering</a>\r\n<a href=\"https://www.bennadel.com/blog/2991-cross-site-request-forgery-csrf-xsrf-race-condition-in-angularjs.htm\">https://www.bennadel.com/blog/2991-cross-site-request-forgery-csrf-xsrf-race-condition-in-angularjs.htm</a>\r\n<a href=\"https://blog.nigelsim.org/2022-06-04-csrf-for-stateless-sso-apis/\">https://blog.nigelsim.org/2022-06-04-csrf-for-stateless-sso-apis/</a></p>","frontmatter":{"title":"CSRF Token 在 Stateless 中所造成的競爭條件","date":"November 13, 2022","description":"往往我們在 Spring Security 中要進行無狀態的服務撰寫時，將會設置 SessionCreationPolicy.STATELESS 使 Spring Security 不會產生 Session，然而在 Spring CSRF 防範的機制中，這樣的設定將會造成每個請求都會 Rotated CSRF Token。"}},"previous":{"fields":{"slug":"/重拾初衷/"},"frontmatter":{"title":"重拾初衷"}},"next":{"fields":{"slug":"/【Design Pattern】責任鏈模式(Chain Of Responsibility)/"},"frontmatter":{"title":"【Design Pattern】責任鏈模式(Chain Of Responsibility)"}}},"pageContext":{"id":"e6301c50-d77a-59db-bda5-dffd3f3b5365","previousPostId":"0c21423c-d5c4-55f4-9d4a-1e3a1ed60ac0","nextPostId":"281f5d35-6a6f-5b61-8458-61c497efab8e"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}