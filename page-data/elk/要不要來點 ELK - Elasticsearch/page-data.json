{"componentChunkName":"component---src-templates-blog-post-js","path":"/elk/要不要來點 ELK - Elasticsearch/","result":{"data":{"site":{"siteMetadata":{"title":"Andy Diary"}},"markdownRemark":{"id":"28432f50-6862-55f8-9bc4-ce7e5a2937d8","excerpt":"Git項目位置: https://github.com/Kuan-Wei-Kuo/elk-demo 什麼是 Elasticsearch ? Elasticsearch 是一套開源且基於 Apache lucene 的分散式搜尋引擎，因此搜尋效能非常好。通常我們會將資料儲放到 Elasticsearch…","html":"<ul>\n<li>Git項目位置: <a href=\"https://github.com/Kuan-Wei-Kuo/elk-demo\">https://github.com/Kuan-Wei-Kuo/elk-demo</a></li>\n</ul>\n<h2>什麼是 Elasticsearch ?</h2>\n<p>Elasticsearch 是一套開源且基於 Apache lucene 的分散式搜尋引擎，因此搜尋效能非常好。通常我們會將資料儲放到 Elasticsearch 進行存儲與分析，在存儲部份我們可以將 Elasticsearch 當作一種 NoSQL 資料庫，也因 ES 是分散式的，意味著我們每個 ES 節點可以代管不同的分片，加速整體資料讀取效率。</p>\n<h2>裝個 Elasticsearch</h2>\n<h3>Edit elasticsearch configuration</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">## elasticsearch.yml</span>\r\n\r\n<span class=\"token key atrule\">network.host</span><span class=\"token punctuation\">:</span> 0.0.0.0\r\n<span class=\"token key atrule\">discovery.type</span><span class=\"token punctuation\">:</span> single<span class=\"token punctuation\">-</span>node</code></pre></div>\n<h3>Run elasticsearch</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-p</span> <span class=\"token number\">9200</span>:9200 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-p</span> <span class=\"token number\">9300</span>:9300 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro <span class=\"token punctuation\">\\</span>\r\nelasticsearch:7.17.9</code></pre></div>\n<h2>Logstash(Indexer)</h2>\n<p>在上一章節，我們成功將資料丟到 Redis 了，接下來我們將嘗試把 Redis 的資料，丟到 Logstash(Indexer) 上，由 Indexer 幫我們解析資料，並且設定相關 Index。</p>\n<h3>Edit pipeline configuration</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> ./logstash/pipeline\r\n<span class=\"token builtin class-name\">cd</span> ./logstash/pipeline\r\n<span class=\"token function\">vi</span> traefik-indexer-pipeline.config</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">input {\r\n  redis {\r\n    data_type =&gt; &quot;list&quot;\r\n    key =&gt; &quot;traefik-log&quot;\r\n    host =&gt; &quot;192.168.144.5&quot;\r\n    port =&gt; &quot;6379&quot;\r\n  }\r\n}\r\n\r\nfilter {\r\n  dissect {\r\n      mapping =&gt; {\r\n        &quot;message&quot; =&gt; &#39;%{source.address} %{traefik.access.user_identifier} %{user.name} [%{traefik.access.time}] &quot;%{http.request.method} %{url.original} HTTP/%{http.version}&quot; %{http.response.status_code} %{traefik.access.message}&#39;\r\n    }\r\n  }\r\n  date {\r\n    match =&gt; [&quot;traefik.access.time&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]\r\n\t  remove_field =&gt; [&quot;traefik.access.time&quot;]\r\n  }\r\n}\r\n\r\noutput {\r\n  elasticsearch {\r\n    hosts =&gt; [&quot;192.168.144.5:9200&quot;]\r\n\t  index =&gt; &quot;traefik-log-%{[host][name]}-%{+YYYY.MM.dd}&quot;\r\n  }\r\n} </code></pre></div>\n<p>接下來我們分析一下這個設定檔在做什麼事情</p>\n<ul>\n<li>Input: 從 Redis 中的 traefik-log 取得資料</li>\n<li>Filter: 使用 message 進行資料的 mapping，在這邊我們將會註記多個欄位加入我們的資料。然而我們為了讓 log 時間等於 timestamp 時間，因此我們將 traefik-log 的時間取代為 timestamp。</li>\n<li>Output: 將資料放入 ES 中，並且 index 規劃為 traefik-log-{hostname}-{date} 進行時間切割，這樣我們就能知道這筆 index 屬於哪台主機以及是哪一天的資料。</li>\n</ul>\n<p>按照上一輪的範例，我們 pipeline 資料夾內應該要有兩個 config 檔案了。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">andy@andy:~/blog-elk-demo/logstash/pipeline$ <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-al</span>\r\n-rw-rw-r-- <span class=\"token number\">1</span> andy andy  <span class=\"token number\">650</span> Mar <span class=\"token number\">18</span> <span class=\"token number\">13</span>:37 traefik-indexer-pipeline.config\r\n-rw-rw-r-- <span class=\"token number\">1</span> andy andy  <span class=\"token number\">191</span> Mar <span class=\"token number\">18</span> <span class=\"token number\">13</span>:34 traefik-shipper-pipeline.config</code></pre></div>\n<h3>Run logstash</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">5000</span>:5000 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/pipeline:/usr/share/logstash/pipeline:ro <span class=\"token punctuation\">\\</span>\r\nlogstash:7.17.9</code></pre></div>\n<h2>Testing</h2>\n<p>我們嘗試使用 Elasticsearch API 看看是否有資料進入。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> GET <span class=\"token string\">\"http://192.168.144.5:9200/_search?pretty\"</span></code></pre></div>\n<p>我們將會看到類似以下的 JSON 回傳</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\r\n  <span class=\"token property\">\"took\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">13</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"timed_out\"</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"_shards\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token property\">\"total\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token property\">\"successful\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token property\">\"skipped\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token property\">\"failed\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"hits\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token property\">\"total\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token property\">\"value\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token property\">\"relation\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"gte\"</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token property\">\"max_score\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token property\">\"hits\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\r\n      <span class=\"token punctuation\">{</span>\r\n        <span class=\"token property\">\"_index\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"traefik-log-617af695dd70-2023.03.04\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token property\">\"_type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"_doc\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token property\">\"_id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"11_09IYB4jZztLyLcEps\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token property\">\"_score\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token property\">\"_source\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token property\">\"url.original\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"/api/overview\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"message\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"192.168.144.3 - - [04/Mar/2023:04:42:39 +0000] \\\"GET /api/overview HTTP/1.1\\\" 200 485 \\\"-\\\" \\\"-\\\" 540 \\\"api@internal\\\" \\\"-\\\" 0ms\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"agent\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token property\">\"id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"a0bf57a2-5430-4dae-9bc7-1e9280237456\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"ephemeral_id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"50fb1ad5-3f2a-40cf-8bf6-a4cfaf159217\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"version\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"7.17.9\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"filebeat\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"hostname\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"617af695dd70\"</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"617af695dd70\"</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"source.address\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"192.168.144.3\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"http.request.method\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"user.name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"-\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"http.version\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1.1\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"http.response.status_code\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"200\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"ecs\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token property\">\"version\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1.12.0\"</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"log\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token property\">\"offset\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">64043</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token property\">\"file\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n              <span class=\"token property\">\"path\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"/home/andy/elk-demo/traefik/logs/access.log\"</span>\r\n            <span class=\"token punctuation\">}</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"@version\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"@timestamp\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2023-03-04T04:42:39.000Z\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"input\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"log\"</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"traefik.access.user_identifier\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"-\"</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"host\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"617af695dd70\"</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"tags\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\r\n            <span class=\"token string\">\"beats_input_codec_plain_applied\"</span>\r\n          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token property\">\"traefik.access.message\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"485 \\\"-\\\" \\\"-\\\" 540 \\\"api@internal\\\" \\\"-\\\" 0ms\"</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n\t  ...\r\n\t<span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">}</span> </code></pre></div>\n<p>以上就可以證明我們將資料確實傳送到 Elasticsearch 了。</p>\n<h2>結論</h2>\n<p>在 DevOps 中，監控是不可或缺的一環，資料的分析以及蒐集都是為了讓系統更佳的穩定，並且在其中找出弱點加以修正。本次並沒有辦法很完全的展現 Elasticsearch 的一些特性，待以後有閒情逸致時再來詳細了解了。</p>\n<p>感冒的一天，不太好受，文字中也許不是那麼完善，請各位體諒了。</p>\n<h2>參考</h2>\n<p><a href=\"https://ithelp.ithome.com.tw/articles/10237875?sc=hot\">https://ithelp.ithome.com.tw/articles/10237875?sc=hot</a></br>\r\n<a href=\"https://zh.wikipedia.org/zh-tw/Elasticsearch\">https://zh.wikipedia.org/zh-tw/Elasticsearch</a></p>","frontmatter":{"title":"要不來點 ELK - Logstash(Indexer) with Elasticsearch","date":"2023-03-18","description":null}},"previous":{"fields":{"slug":"/elk/要不要來點 ELK - Logstash/"},"frontmatter":{"title":"要不來點 ELK - Logstash(Shipper)"}},"next":{"fields":{"slug":"/elk/要不要來點 ELK - Kibana/"},"frontmatter":{"title":"要不來點 ELK - Kibana"}}},"pageContext":{"id":"28432f50-6862-55f8-9bc4-ce7e5a2937d8","previousPostId":"4ed809a8-82d4-5a6d-a1a8-24d57be47976","nextPostId":"2eaa1d4d-90a7-5a05-9b0f-9e8f9ae4c775"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}