{"componentChunkName":"component---src-templates-blog-post-js","path":"/elk/要不要來點 ELK - Filebeat/","result":{"data":{"site":{"siteMetadata":{"title":"Andy Diary"}},"markdownRemark":{"id":"994eb191-3614-526d-9a93-7ac54dcd4dee","excerpt":"Git項目位置: https://github.com/Kuan-Wei-Kuo/elk-demo 什麼是 Filebeat ? 如果我們去 Filebeat 介紹頁面，會看看斗大的 Lightweight shipper for logs 字眼，意思就是說 Filebeat…","html":"<ul>\n<li>Git項目位置: <a href=\"https://github.com/Kuan-Wei-Kuo/elk-demo\">https://github.com/Kuan-Wei-Kuo/elk-demo</a></li>\n</ul>\n<h2>什麼是 Filebeat ?</h2>\n<p>如果我們去 Filebeat 介紹頁面，會看看斗大的 Lightweight shipper for logs 字眼，意思就是說 Filebeat 是一個輕量日誌採集器，其主要工作就是幫助我們進行日誌收集，下面讓我們看看有那些特色。</p>\n<ul>\n<li>輕量日誌採集器，設定方式簡潔。</li>\n<li>提供許多模組可快速接收與解析日誌，如 Traefik、Nginx、MySQL 等。</li>\n<li>Filebeat 有自己的 Registry 文件，不會因為系統重啟而重複發送日誌。</li>\n<li>若連接一方為 Logstash 或者 Elasticsearch 時，會自動檢視對方是否過載，若過載將降低傳輸速度，直到系統恢復正常。</li>\n</ul>\n<p>我們簡單的介紹過 Filebeat 之後，接下來讓我們利用 Docker 來體驗一下它的魔力。</p>\n<h2>Say hello to Traefik</h2>\n<p>Traefik 與 Nginx 一樣，都是一套反向代理工具，今天我們就不多做介紹(其實我有點懶)，直接開玩。</p>\n<h3>Step 1. Edit traefik.yml</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">## traefik.yml</span>\r\n\r\n<span class=\"token comment\"># Docker configuration backend</span>\r\n<span class=\"token key atrule\">providers</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">defaultRule</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Host(`{{ trimPrefix `/` .Name }}.docker.localhost`)\"</span>\r\n\r\n<span class=\"token comment\"># API and dashboard configuration</span>\r\n<span class=\"token key atrule\">api</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">insecure</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n\r\n<span class=\"token comment\"># Enable access log</span>\r\n<span class=\"token key atrule\">accessLog</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">filePath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/etc/traefik/logs/access.log\"</span></code></pre></div>\n<h3>Step 2. Run traefik</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8080</span>:8080 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/traefik.yml:/etc/traefik/traefik.yml <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/logs:/etc/traefik/logs <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class=\"token punctuation\">\\</span>\r\ntraefik:v2.5</code></pre></div>\n<p>沒意外大家現在已經可以訪問 <a href=\"http://localhost:8080\">http://localhost:8080</a> 了，接下來讓我們嘗試使用 Filebeat 進行資料存取測試。</p>\n<h2>Hi, Filebeat</h2>\n<p>接下來我們來看看 Filebeat 基礎服務如何實現。</p>\n<h3>Step 1. Edit filebeat.yml</h3>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">## filebeat.yml</span>\r\n<span class=\"token key atrule\">filebeat.inputs</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> log\r\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/home/andy/elk-demo/traefik/logs/access.log*\"</span><span class=\"token punctuation\">]</span>\r\n\r\n<span class=\"token key atrule\">processors</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">add_id</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">~</span>\r\n\r\n<span class=\"token key atrule\">output.file</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n  <span class=\"token key atrule\">codec.json</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">pretty</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n  <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/tmp/filebeat/\"</span>\r\n  <span class=\"token key atrule\">filename</span><span class=\"token punctuation\">:</span> filebeat\r\n  <span class=\"token key atrule\">rotate_every_kb</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10000</span>\r\n  <span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1001</span></code></pre></div>\n<p>Filebeat 有許多設定方式，其中不乏與優化息息相關，但目前我們尚不需要得知，不過建議同學玩過一輪後，拜讀一下 <a href=\"https://ithelp.ithome.com.tw/articles/10274944\">Filebeat 應該要了解的設計細節與原理</a>，裡面有更多詳細的解答。</p>\n<ul>\n<li>inputs: 我們將在這邊告知 Filebeat 要抓的類型、是否啟動、以及檔案路徑。</li>\n<li>processors: 在資料往後送之前，會做一些簡單加工，通常我們會使用其他進行去重複的動作，在這邊因為內容資料並無法讓我們使用其內容產生 ID，所以我們使用 add_id: ~ 來讓 Filebeat 自動產生 ID。</li>\n<li>output: 在 Filebeat 提供許多 Output 方式，例如 Logstash、Elasticsearch、Redis、Kafka 等，但本次我們只想要證明 Filebeat 是否有撈取資料，因此僅使用 File 來輸出。</li>\n</ul>\n<h3>Step 2. Run filebeat</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-v</span> <span class=\"token environment constant\">$PWD</span>/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-v</span> /home/andy/elk-demo/traefik/logs:/home/andy/elk-demo/traefik/logs:ro <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-v</span> /home/andy/blog-elk-demo/filebeat/logs:/tmp/filebeat <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">--user</span> root <span class=\"token punctuation\">\\</span>\r\nelastic/filebeat:7.17.9 <span class=\"token punctuation\">\\</span>\r\n<span class=\"token parameter variable\">-e</span> <span class=\"token parameter variable\">--strict.perms</span><span class=\"token operator\">=</span>false</code></pre></div>\n<h2>Testing</h2>\n<p>來讓我們測試一下，Filebeat 是否開始如願擷取我們的 access.log 呢?</p>\n<p>按照我們 Volume 所設定，在我們的 /home/andy/blog-elk-demo/filebeat/logs 應該要與 Filebeat 所產生檔案的路徑進行關聯。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> /home/andy/blog-elk-demo/filebeat/logs\r\n<span class=\"token function\">ls</span>\r\n<span class=\"token comment\"># filebeat filebeat.1</span></code></pre></div>\n<p>沒意外我們會看到 filebeat 的檔案，這時候我們嘗試打開檔案會如下圖中顯示。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d71f44f3f9dd80d3170c4cbe8bd0590a/9efb3/filebeat_ans_01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.759493670886075%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAABJ0AAASdAHeZh94AAAAU0lEQVR42l3ISw6AIAxFUT5l4CuVUlIw7n+hJjgx3tHJDX6v7tbNejcARESlpF85f5xiimmPMK/l08cY5sOWtaaqKqeAwZUB1B0Dx2upYK4iYH4AC5oEuyyhIbwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"filebeat_ans_01\"\n        title=\"\"\n        src=\"/static/d71f44f3f9dd80d3170c4cbe8bd0590a/f058b/filebeat_ans_01.png\"\n        srcset=\"/static/d71f44f3f9dd80d3170c4cbe8bd0590a/c26ae/filebeat_ans_01.png 158w,\n/static/d71f44f3f9dd80d3170c4cbe8bd0590a/6bdcf/filebeat_ans_01.png 315w,\n/static/d71f44f3f9dd80d3170c4cbe8bd0590a/f058b/filebeat_ans_01.png 630w,\n/static/d71f44f3f9dd80d3170c4cbe8bd0590a/40601/filebeat_ans_01.png 945w,\n/static/d71f44f3f9dd80d3170c4cbe8bd0590a/78612/filebeat_ans_01.png 1260w,\n/static/d71f44f3f9dd80d3170c4cbe8bd0590a/9efb3/filebeat_ans_01.png 1894w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>結論</h2>\n<p>目前使用至此，Filebeat 的設定並不困難，若是服務不大的情況，基本上可以說開箱即用了，當然安全一點還是得去了解 Filebeat 相關機制，才可以設計出合適的設定。</p>\n<p>在下一篇中，我們將開始整合 Redis 與 Logstash 讓我們的日誌能到緩存至 Broker。</p>\n<h2>參考</h2>\n<p><a href=\"https://www.elastic.co/beats/filebeat\">https://www.elastic.co/beats/filebeat</a></br>\r\n<a href=\"https://ithelp.ithome.com.tw/articles/10274944\">https://ithelp.ithome.com.tw/articles/10274944</a></p>","frontmatter":{"title":"要不來點 ELK - Filebeat","date":"2023-03-07","description":null}},"previous":{"fields":{"slug":"/elk/要不來點 ELK/"},"frontmatter":{"title":"要不來點 ELK"}},"next":{"fields":{"slug":"/elk/要不要來點 ELK - Logstash/"},"frontmatter":{"title":"要不來點 ELK - Logstash(Shipper)"}}},"pageContext":{"id":"994eb191-3614-526d-9a93-7ac54dcd4dee","previousPostId":"4929f0ba-b512-5743-b06d-35e6d058572b","nextPostId":"4ed809a8-82d4-5a6d-a1a8-24d57be47976"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}