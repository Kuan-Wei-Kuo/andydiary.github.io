{"componentChunkName":"component---src-templates-blog-post-js","path":"/淺談悲觀鎖與實戰/","result":{"data":{"site":{"siteMetadata":{"title":"Andy Diary"}},"markdownRemark":{"id":"db4bed9f-17c5-5af6-bdd7-66d18cd1f7e6","excerpt":"在大量請求下，在業務上容易發生併發情況，如果不好好保持資料原子性，那麼我們的資料最終結果並不可信，可以想像若在與金流相關系統上發生這種問題，這將是個災難。 其實說白了，就是要避免競爭條件(Race condition)。 悲觀鎖 悲觀鎖(Pessimistic Locking…","html":"<p>在大量請求下，在業務上容易發生併發情況，如果不好好保持資料原子性，那麼我們的資料最終結果並不可信，可以想像若在與金流相關系統上發生這種問題，這將是個災難。</p>\n<p>其實說白了，就是要避免<strong>競爭條件(Race condition)</strong>。</p>\n<h2>悲觀鎖</h2>\n<p><strong>悲觀鎖(Pessimistic Locking)</strong>，悲觀點在於認為資料並不安全，資料更新需求非常高，因此我們要在每次拿數據時都上鎖，在這期間其他請求將會 <strong>Block</strong> 直至放鎖，等待下一個請求進行上鎖。從上述的描述，其實我們不難發現 Java 中的 <strong>Synchronized</strong> 就屬於悲觀鎖的實現，甚至資料庫許多鎖表機制也是屬於悲觀鎖。</p>\n<h2>實戰</h2>\n<p>在傳統 RDB 上，我們可使用 SELECT ... FOR UPDATE 來針對 ROW 進行上鎖，直到後續 Commit 後才進行放鎖動作。</p>\n<p>假設現在我們有一個庫存資料表，表格內容如下。</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Column</th>\n<th align=\"center\">Type</th>\n<th align=\"center\">Primary Key</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">product_id</td>\n<td align=\"center\">INT</td>\n<td align=\"center\">YES</td>\n</tr>\n<tr>\n<td align=\"center\">amount</td>\n<td align=\"center\">INT</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">version</td>\n<td align=\"center\">INT</td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n<h3>Spring Data JPA</h3>\n<p>在 Spring Data JPA 中我們可以更加優雅的使用 <strong>@Lock</strong> 來幫助我們進行悲觀鎖的實現。</p>\n<h4>Entity</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\r\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"stock\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Stock</span> <span class=\"token punctuation\">{</span>\r\n\r\n\t<span class=\"token annotation punctuation\">@Id</span>\r\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"product_id\"</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> productId<span class=\"token punctuation\">;</span>\r\n\r\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"amount\"</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> amount<span class=\"token punctuation\">;</span>\r\n\t\r\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"version\"</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> version<span class=\"token punctuation\">;</span>\r\n\r\n\t<span class=\"token comment\">// getters and setters</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Repository</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Repository</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">StockRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Stock</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token annotation punctuation\">@Lock</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">LockModeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PESSIMISTIC_WRITE</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT s FROM Stock s WHERE s.productId = :productId\"</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Stock</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findByProductId</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Service</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\r\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StockServiceImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">StockService</span> <span class=\"token punctuation\">{</span>\r\n\r\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">StockRepository</span> stockRepository<span class=\"token punctuation\">;</span>\r\n\t\r\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">StockServiceImpl</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StockRepository</span> stockRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stockRepository <span class=\"token operator\">=</span> stockRepository<span class=\"token punctuation\">;</span>\r\n\t<span class=\"token punctuation\">}</span>\r\n\t\r\n\t<span class=\"token annotation punctuation\">@Transactional</span>\r\n\t<span class=\"token annotation punctuation\">@Override</span>\r\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">StockDto</span> <span class=\"token function\">checkStock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> productId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> amount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Stock</span><span class=\"token punctuation\">></span></span> optional <span class=\"token operator\">=</span> stockRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByProductId</span><span class=\"token punctuation\">(</span>productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t\r\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>optional<span class=\"token punctuation\">.</span><span class=\"token function\">isPresent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"product id not found, id: \"</span> <span class=\"token operator\">+</span> productId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token punctuation\">}</span>\r\n\t\t\r\n\t\t<span class=\"token class-name\">Stock</span> stock <span class=\"token operator\">=</span> optional<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        \r\n\t\t<span class=\"token keyword\">int</span> existAmount <span class=\"token operator\">=</span> stock<span class=\"token punctuation\">.</span><span class=\"token function\">getAmount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token keyword\">int</span> existVersion <span class=\"token operator\">=</span> stock<span class=\"token punctuation\">.</span><span class=\"token function\">getVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        \r\n\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>existAmount <span class=\"token operator\">>=</span> amount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t\tstock<span class=\"token punctuation\">.</span><span class=\"token function\">setAmount</span><span class=\"token punctuation\">(</span>existAmount <span class=\"token operator\">-</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token punctuation\">}</span>\r\n\t\tstock<span class=\"token punctuation\">.</span><span class=\"token function\">setVersion</span><span class=\"token punctuation\">(</span>existVersion <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\tstockRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">convertToDto</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t<span class=\"token punctuation\">}</span>\r\n\t\r\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">StockDto</span> <span class=\"token function\">convertToDto</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stock</span> stock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t\t<span class=\"token class-name\">StockDto</span> stockDto <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StockDto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\tstockDto<span class=\"token punctuation\">.</span><span class=\"token function\">setProductId</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">.</span><span class=\"token function\">getProductId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\tstockDto<span class=\"token punctuation\">.</span><span class=\"token function\">setAmount</span><span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">.</span><span class=\"token function\">getAmount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token keyword\">return</span> stockDto<span class=\"token punctuation\">;</span>\r\n\t<span class=\"token punctuation\">}</span>\r\n\t\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>模擬測試</h2>\n<ol>\n<li>庫存數量為 100</li>\n<li>QPS 平均為 100/sec</li>\n</ol>\n<h3>Test case 1</h3>\n<p>如上述條件為基礎下，我們將在 <strong>stockRepository.save</strong> 之前將 <strong>Thread.sleep(3 * 1000L)</strong>。在這個測試情結下，我們可以測試在併發時，是否有真的進行上鎖動作。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/13fef5cc55fae65ba4d5da050722dcfb/a8417/rhgZp9K.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.0379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA0UlEQVR42q3RXU7EIBSGYVbjCtQKUzj8lrbQTtvRjMZM3P8qPlMmMc7ERKtevIFw8QQOzIQGZD2UsfCxQ79fEPsBocuYjifEPEFIwk7pi2oypetzNj4t6NIIoQih7TE/nzAcjmjzgJhGmBChXYD24bx+Exse5wKuuvUNjPOlda+0hdQGsqw/i6VlQuwyatIg4758xpaYbBLuVYubW8JdbSALaD5mtDX2WnGkSoB/Qq6Hvgl8qzjmimNH59v9BrkAX7jA/kH8I+gcMtmCrL/6V/Ad3gE7f/HNKvMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rhgZp9K\"\n        title=\"rhgZp9K\"\n        src=\"/static/13fef5cc55fae65ba4d5da050722dcfb/f058b/rhgZp9K.png\"\n        srcset=\"/static/13fef5cc55fae65ba4d5da050722dcfb/c26ae/rhgZp9K.png 158w,\n/static/13fef5cc55fae65ba4d5da050722dcfb/6bdcf/rhgZp9K.png 315w,\n/static/13fef5cc55fae65ba4d5da050722dcfb/f058b/rhgZp9K.png 630w,\n/static/13fef5cc55fae65ba4d5da050722dcfb/a8417/rhgZp9K.png 941w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>可以看到在前面幾個的 Request 都已經完成，但後續的 Request 很大概率會因為 Connection Timeout 機制導致出錯，這也根本上的代表我們確實將該筆資料進行上鎖了。</p>\n<h3>Test case 2</h3>\n<p>一樣在上述的基礎下，我們這次將移除 <strong>Thread.sleep(3 * 1000L)</strong> 並且觀察庫存是否有超賣問題。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fefd39532f3d823bc065f734472adf46/d5c6f/32Ulhz9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.278481012658226%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhUlEQVR42p2PSw7DIAwFuVcrMLYhKRAF1Puf5VWAKvWzaJPFSG/j0dhwXOA1glgRbhlr2bGkDbneQRphWXB1/m8M5YDSKiwxYipD1MWyFjhWOBY40d+wgjRMYa47nJdxbD2PfbF0qOytcGsNluZrXTR43QcwlGZhf/lM0Veh/yh8Vp4VPgDyXtLdfGcX2QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"32Ulhz9\"\n        title=\"32Ulhz9\"\n        src=\"/static/fefd39532f3d823bc065f734472adf46/f058b/32Ulhz9.png\"\n        srcset=\"/static/fefd39532f3d823bc065f734472adf46/c26ae/32Ulhz9.png 158w,\n/static/fefd39532f3d823bc065f734472adf46/6bdcf/32Ulhz9.png 315w,\n/static/fefd39532f3d823bc065f734472adf46/f058b/32Ulhz9.png 630w,\n/static/fefd39532f3d823bc065f734472adf46/40601/32Ulhz9.png 945w,\n/static/fefd39532f3d823bc065f734472adf46/78612/32Ulhz9.png 1260w,\n/static/fefd39532f3d823bc065f734472adf46/d5c6f/32Ulhz9.png 1261w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>這次可以看到我們請求都正常了，該檢視一下庫存是否超賣了。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 255px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/93af15d7705a84a8371612b905611396/b8c8f/LOt0mQQ.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.848101265822784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABHElEQVR42nWQ2WrCUBRF/f8P6U/0sVAIpSFSKY0ZzGRu5uma1Oi9rmK04EO7YcOBzVlnWMVRTF1VtG1DWZZkImPoe/IsxTRN1taaLM+Jgh2GYZDlJVddLhf+0mptWWy3Po6f4LouruvRdT11VfBumhjGG/t9SuB7mKZFXlRLo9aaeZ6Z5xP6Dr8OWS1Vt4HdE3U7kcQRQRhR1w1V1SzxMEPSTsihJ4pikjghTTPOSqOVIhOCYBcQx+kNeOk9VPJMEAm2to3r+kRhiBDpAmyP4IiOPBPYX/ZyRVEWy3bz8YjrOHxuPvB85w7kbwXh/2kSK5qmYZq+gTMiVby+6BtQa7VYqUdrBqmWXz36N5PyhJSScRwZxwNNI0n3B34ATSTHo4m9xhYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"LOt0mQQ\"\n        title=\"LOt0mQQ\"\n        src=\"/static/93af15d7705a84a8371612b905611396/b8c8f/LOt0mQQ.png\"\n        srcset=\"/static/93af15d7705a84a8371612b905611396/c26ae/LOt0mQQ.png 158w,\n/static/93af15d7705a84a8371612b905611396/b8c8f/LOt0mQQ.png 255w\"\n        sizes=\"(max-width: 255px) 100vw, 255px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>在上圖中我們可以發現，<strong>version</strong> 為 <strong>200</strong>，證明了我們確實都完成了請求，然而在 QPS 平均為 100 的情況下，我們也 <strong>amount</strong> 也沒有發生超賣情形。</p>\n<h2>結論</h2>\n<p>在實現悲觀鎖的過程中，我們不難發現，在這種誰先取得 Lock 誰先動作的過程，其實也是確保了執行的順序。</p>\n<p>大家不妨使用 Java Synchronized 來進行 Multi-thread 程式撰寫，其實也是相同道理，都是要處理競爭條件的。</p>","frontmatter":{"title":"淺談悲觀鎖與實戰","date":"2023-01-22","description":null}},"previous":{"fields":{"slug":"/leetcode/【LeetCode】695. Max Area of Island/"},"frontmatter":{"title":"【LeetCode】695. Max Area of Island"}},"next":null},"pageContext":{"id":"db4bed9f-17c5-5af6-bdd7-66d18cd1f7e6","previousPostId":"4aa8a80a-c933-54f0-90bc-7ebfc2a2764b","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}